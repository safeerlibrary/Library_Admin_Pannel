<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Safeer Library Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen relative">

  <nav class="w-full bg-white shadow p-3 flex flex-wrap items-center gap-3 justify-between sticky top-0 z-10">
    <div class="flex items-center gap-2">
      <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold">S</div>
      <div>
        <div class="text-xl font-bold">Safeer Library</div>
        <div class="text-sm text-gray-500 hidden md:block">Admin Panel</div>
      </div>
    </div>

    <div class="flex-1 max-w-md order-3 w-full md:w-auto md:order-none">
      <input id="searchInput" type="text" placeholder="Search book, subject, or class..."
        class="w-full border rounded-lg p-2 shadow-sm focus:ring-2 focus:ring-blue-500 outline-none" />
    </div>

    <div class="flex items-center gap-2">
      <select id="classSelect" class="border rounded-lg p-2"></select>
      <button id="reloadBtn" class="px-3 py-2 bg-gray-800 text-white rounded-lg text-sm hover:bg-gray-700">Refresh</button>
    </div>
  </nav>

  <div class="px-4 py-2 text-sm text-gray-600 flex justify-between items-center bg-gray-100 border-b">
    <span id="lastUpdated">Last updated: checking...</span>
    <span>Showing <span id="countDisplay" class="font-bold">0</span> records</span>
  </div>

  <div id="cardsContainer" class="p-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 pb-20">
    <div class="text-gray-400 text-center col-span-full">Loading data...</div>
  </div>

  <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">
      <div class="bg-blue-600 p-4 text-white flex justify-between items-center">
        <h3 class="font-bold text-lg" id="modalTitle">Edit Book</h3>
        <button onclick="closeModal()" class="text-white hover:text-gray-200 text-xl">&times;</button>
      </div>
      
      <form id="editForm" class="p-5 space-y-4">
        <input type="hidden" id="editSheetName">
        <input type="hidden" id="editBookNameOriginal">

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-bold text-gray-500 uppercase">Quantity</label>
            <input type="number" id="editQuantity" class="w-full border p-2 rounded focus:ring-blue-500 focus:border-blue-500">
          </div>
          <div>
            <label class="block text-xs font-bold text-gray-500 uppercase">Sale</label>
            <input type="number" id="editSale" class="w-full border p-2 rounded focus:ring-blue-500 focus:border-blue-500">
          </div>
          <div>
            <label class="block text-xs font-bold text-gray-500 uppercase">Taken by Teacher</label>
            <input type="number" id="editTeacher" class="w-full border p-2 rounded focus:ring-blue-500 focus:border-blue-500">
          </div>
          <div>
            <label class="block text-xs font-bold text-gray-500 uppercase">Return</label>
            <input type="number" id="editReturn" class="w-full border p-2 rounded focus:ring-blue-500 focus:border-blue-500">
          </div>
          <div>
            <label class="block text-xs font-bold text-gray-500 uppercase">New Receive</label>
            <input type="number" id="editNewReceive" class="w-full border p-2 rounded focus:ring-blue-500 focus:border-blue-500">
          </div>
          <div>
            <label class="block text-xs font-bold text-gray-500 uppercase">Total Book</label>
            <input type="number" id="editTotal" class="w-full border p-2 rounded focus:ring-blue-500 focus:border-blue-500 bg-gray-100">
          </div>
        </div>

        <div>
            <label class="block text-xs font-bold text-gray-500 uppercase">Note</label>
            <textarea id="editNote" class="w-full border p-2 rounded focus:ring-blue-500 focus:border-blue-500" rows="2"></textarea>
        </div>

        <div class="flex gap-3 pt-2">
          <button type="button" onclick="closeModal()" class="flex-1 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
          <button type="submit" id="saveBtn" class="flex-1 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex justify-center items-center gap-2">
            <span>Save Changes</span>
          </button>
        </div>
      </form>
    </div>
  </div>

<script>
// ⚠️ PASTE YOUR GOOGLE APPS SCRIPT WEB APP URL HERE
const SCRIPT_URL = "PASTE_YOUR_WEB_APP_URL_HERE"; 

// ---- CONFIGURATION ----
const SHEETS = [
  { name: "Nursery", gid: "2090458225" },
  { name: "Reception", gid: "1846395443" },
  { name: "Year 1", gid: "1978300943" },
  { name: "Year 2", gid: "862928818" },
  { name: "Year 3", gid: "773616211" },
  { name: "Year 4", gid: "1733381232" },
  { name: "Year 5", gid: "358390641" },
  { name: "Year 6", gid: "1319776648" },
  { name: "Year 7", gid: "1802575893" },
  { name: "Year 8", gid: "1794593989" },
  { name: "Year 9", gid: "157753930" },
  { name: "Question Paper", gid: "882635163" }
];

const BASE = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSB63Lx0NFr6yE9-EhAjkW8KoxCHrGTzpMniovT8auFrAg3PK6DUrtuQNYr3HVxjjuo5Q6tfA0BEk2m/pub?gid=";
const SHEET_ID_RAW = "1vSB63Lx0NFr6yE9-EhAjkW8KoxCHrGTzpMniovT8auFrAg3PK6DUrtuQNYr3HVxjjuo5Q6tfA0BEk2m";
const META_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID_RAW}/gviz/tq?tqx=out:json`;

// DOM Elements
const cardsContainer = document.getElementById("cardsContainer");
const classSelect = document.getElementById("classSelect");
const searchInput = document.getElementById("searchInput");
const reloadBtn = document.getElementById("reloadBtn");
const countDisplay = document.getElementById("countDisplay");
const lastUpdated = document.getElementById("lastUpdated");

// Modal Elements
const editModal = document.getElementById("editModal");
const editForm = document.getElementById("editForm");

let allRows = [];
let filteredRows = [];

// Setup Dropdown
classSelect.innerHTML = `<option>All Classes</option>` + SHEETS.map(s => `<option>${s.name}</option>`).join("");

// ---- 1. Fetch Data ----
async function fetchLastUpdated() {
  try {
    const res = await fetch(META_URL);
    const text = await res.text();
    const json = JSON.parse(text.substring(47, text.length - 2));
    lastUpdated.textContent = `Last updated: ${new Date(json.table.updated).toLocaleString()}`;
  } catch (e) { lastUpdated.textContent = "Last updated: unavailable"; }
}

async function fetchAllSheets() {
  cardsContainer.innerHTML = '<div class="col-span-full text-gray-400 text-center py-12 animate-pulse">Loading library data...</div>';
  
  try {
    const allData = await Promise.all(
      SHEETS.map(s => fetch(BASE + s.gid + "&single=true&output=csv").then(r => r.text()))
    );

    allRows = [];
    allData.forEach((csvText, i) => {
      const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
      parsed.data.forEach(row => {
        row._sheet = SHEETS[i].name;
        // Add a temporary unique ID for UI handling
        row._id = row["Book Name"] + SHEETS[i].name; 
        allRows.push(normalizeRow(row));
      });
    });

    await fetchLastUpdated();
    applyFilter();
  } catch (e) {
    cardsContainer.innerHTML = '<div class="col-span-full text-red-500 text-center py-12">Failed to load data.</div>';
  }
}

function normalizeRow(r) {
  return {
    Subject: r["Subject"] || "",
    "Book Name": r["Book Name"] || "",
    Quantity: r["Quentity"] || r["Quantity"] || "0",
    Sale: r["Sale"] || "0",
    "Tkn By Teacher": r["Tkn By Teacher"] || r["Taken By Teacher"] || "0",
    Return: r["Return"] || "0",
    "New Receive": r["New Recive"] || r["New Receive"] || "0",
    "Total Book": r["Total Book"] || "0",
    Note: r["Note"] || "",
    _sheet: r._sheet,
    _id: r._id
  };
}

// ---- 2. Filter & Render ----
function applyFilter() {
  const selected = classSelect.value;
  const query = searchInput.value.toLowerCase().trim();
  const queryWords = query.split(/\s+/).filter(Boolean);

  filteredRows = allRows.filter((r) => {
    let ok = selected === "All Classes" || r._sheet === selected;
    if (queryWords.length) {
      const txt = [r["Book Name"], r.Subject, r.Note, r._sheet].join(" ").toLowerCase();
      ok = ok && queryWords.every(w => txt.includes(w));
    }
    return ok;
  });

  renderCards();
}

function renderCards() {
  cardsContainer.innerHTML = "";
  countDisplay.textContent = filteredRows.length;

  if (!filteredRows.length) {
    cardsContainer.innerHTML = '<div class="col-span-full text-gray-400 text-center py-12">No records found.</div>';
    return;
  }

  filteredRows.forEach(r => {
    // We encode the object as a string to pass to the edit function
    const dataStr = encodeURIComponent(JSON.stringify(r));
    
    cardsContainer.innerHTML += `
      <article class="bg-white rounded-2xl p-4 shadow hover:shadow-md transition flex flex-col justify-between border border-gray-100">
        <div>
          <div class="flex justify-between items-start">
            <h3 class="text-lg font-bold text-gray-800 leading-tight">${r["Book Name"]}</h3>
            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full whitespace-nowrap">${r._sheet}</span>
          </div>
          <p class="text-sm text-gray-500 mb-3">${r.Subject}</p>
          
          <div class="grid grid-cols-2 gap-y-1 gap-x-4 text-sm text-gray-600 mb-3 bg-gray-50 p-2 rounded-lg">
            <div class="flex justify-between"><span>Qty:</span> <span class="font-medium">${r.Quantity}</span></div>
            <div class="flex justify-between"><span>Sale:</span> <span class="font-medium">${r.Sale}</span></div>
            <div class="flex justify-between"><span>Teacher:</span> <span class="font-medium">${r["Tkn By Teacher"]}</span></div>
            <div class="flex justify-between"><span>Return:</span> <span class="font-medium">${r.Return}</span></div>
            <div class="flex justify-between"><span>New:</span> <span class="font-medium">${r["New Receive"]}</span></div>
            <div class="flex justify-between text-blue-600 font-bold"><span>Total:</span> <span>${r["Total Book"]}</span></div>
          </div>
          ${r.Note ? `<p class="text-xs text-gray-400 italic border-t pt-2 mb-2">"${r.Note}"</p>` : ""}
        </div>

        <button onclick="openEdit('${dataStr}')" 
          class="w-full mt-2 bg-blue-600 text-white py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition active:scale-95">
          Edit Data
        </button>
      </article>
    `;
  });
}

// ---- 3. Modal Logic ----
function openEdit(dataStr) {
  const data = JSON.parse(decodeURIComponent(dataStr));
  
  document.getElementById('modalTitle').textContent = `Edit: ${data["Book Name"]}`;
  document.getElementById('editSheetName').value = data._sheet;
  document.getElementById('editBookNameOriginal').value = data["Book Name"];
  
  document.getElementById('editQuantity').value = data.Quantity;
  document.getElementById('editSale').value = data.Sale;
  document.getElementById('editTeacher').value = data["Tkn By Teacher"];
  document.getElementById('editReturn').value = data.Return;
  document.getElementById('editNewReceive').value = data["New Receive"];
  document.getElementById('editTotal').value = data["Total Book"];
  document.getElementById('editNote').value = data.Note;

  editModal.classList.remove('hidden');
  editModal.classList.add('flex');
}

function closeModal() {
  editModal.classList.add('hidden');
  editModal.classList.remove('flex');
}

// Auto-calculate Total when inputs change
['editQuantity', 'editSale', 'editTeacher', 'editReturn', 'editNewReceive'].forEach(id => {
  document.getElementById(id).addEventListener('input', calculateTotal);
});

function calculateTotal() {
  const q = parseInt(document.getElementById('editQuantity').value) || 0;
  const s = parseInt(document.getElementById('editSale').value) || 0;
  const t = parseInt(document.getElementById('editTeacher').value) || 0;
  const r = parseInt(document.getElementById('editReturn').value) || 0;
  const n = parseInt(document.getElementById('editNewReceive').value) || 0;
  
  // Formula: (Quantity + New Receive + Return) - (Sale + Teacher)
  // OR based on your sheet logic. Assuming standard library logic:
  // Current Stock = (Initial Quantity + New Receive + Return) - (Sale + Taken By Teacher)
  const total = (q + n + r) - (s + t);
  document.getElementById('editTotal').value = total;
}


// ---- 4. Save Data (Send to Google Sheet) ----
editForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const saveBtn = document.getElementById('saveBtn');
  const originalText = saveBtn.innerHTML;
  
  saveBtn.disabled = true;
  saveBtn.innerHTML = `<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Saving...`;

  const payload = {
    sheetName: document.getElementById('editSheetName').value,
    bookName: document.getElementById('editBookNameOriginal').value,
    quantity: document.getElementById('editQuantity').value,
    sale: document.getElementById('editSale').value,
    teacher: document.getElementById('editTeacher').value,
    returnVal: document.getElementById('editReturn').value,
    newReceive: document.getElementById('editNewReceive').value,
    total: document.getElementById('editTotal').value,
    note: document.getElementById('editNote').value
  };

  try {
    // Note: "no-cors" mode means we won't get a JSON response back, 
    // but the request will successfully reach Google Scripts.
    await fetch(SCRIPT_URL, {
      method: 'POST',
      mode: 'no-cors', 
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify(payload)
    });

    // Wait a moment for Google Sheet to process, then reload
    setTimeout(() => {
      closeModal();
      fetchAllSheets();
      alert("Update Sent! Data will refresh momentarily.");
      saveBtn.disabled = false;
      saveBtn.innerHTML = originalText;
    }, 1500);

  } catch (err) {
    console.error(err);
    alert("Error saving data.");
    saveBtn.disabled = false;
    saveBtn.innerHTML = originalText;
  }
});

// Listeners
searchInput.addEventListener("input", applyFilter);
classSelect.addEventListener("change", applyFilter);
reloadBtn.addEventListener("click", fetchAllSheets);

// Start
fetchAllSheets();
</script>

</body>
</html>